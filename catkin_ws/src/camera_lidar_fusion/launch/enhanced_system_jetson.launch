<launch>
  <!-- Enhanced Camera-LiDAR Fusion System for Jetson Nano -->
  <!-- Optimized for 4GB RAM, 128 CUDA cores, ARM64 architecture -->
  
  <!-- ZED Camera Node -->
  <node name="zed_camera_node" pkg="camera_lidar_fusion" type="zed_camera_node.py" output="screen" />

  <!-- UniLiDAR Node -->
  <node name="unitree_lidar_ros_node" pkg="unitree_lidar_ros" type="unitree_lidar_ros_node" output="screen">
    <param name="port" value="/dev/ttyUSB0" />
    <param name="cloud_topic" value="unilidar/cloud" />
    <param name="cloud_frame" value="unilidar_lidar" />
    <param name="imu_topic" value="unilidar/imu" />
    <param name="imu_frame" value="unilidar_imu" />
  </node>

  <!-- Enhanced Filtering Node (Jetson Nano Optimized) -->
  <node name="enhanced_filtering_node" pkg="camera_lidar_fusion" type="enhanced_filtering_node.py" output="screen">
    <!-- Adaptive Voxel Grid Parameters (Conservative for Nano) -->
    <param name="base_voxel_size" value="0.08" />  <!-- Increased for performance -->
    <param name="max_voxel_size" value="0.20" />
    <param name="min_voxel_size" value="0.05" />
    <param name="density_threshold" value="50" />  <!-- Reduced for memory efficiency -->
    
    <!-- Multi-resolution voxel grid (Conservative) -->
    <param name="distance_ranges" value="[1.0, 3.0, 8.0, 15.0]" />
    <param name="voxel_sizes" value="[0.05, 0.08, 0.12, 0.18]" />
    
    <!-- RANSAC Ground Plane Detection -->
    <param name="ransac_threshold" value="0.15" />  <!-- Increased tolerance -->
    <param name="ransac_min_samples" value="3" />
    <param name="ransac_max_trials" value="500" />  <!-- Reduced for performance -->
    <param name="ground_angle_threshold" value="20.0" />
    
    <!-- Enhanced Outlier Detection (Conservative) -->
    <param name="radius_outlier_radius" value="0.8" />  <!-- Increased radius -->
    <param name="radius_outlier_min_neighbors" value="8" />  <!-- Reduced neighbors -->
    <param name="statistical_outlier_k" value="15" />  <!-- Reduced k -->
    <param name="statistical_outlier_std" value="1.5" />  <!-- Increased tolerance -->
    
    <!-- Temporal Consistency (Reduced for performance) -->
    <param name="temporal_window_size" value="3" />  <!-- Reduced window -->
    <param name="temporal_consistency_threshold" value="0.15" />
    
    <!-- Cluster-based Filtering (Conservative) -->
    <param name="cluster_eps" value="0.5" />  <!-- Increased eps -->
    <param name="cluster_min_samples" value="3" />  <!-- Reduced samples -->
    <param name="min_cluster_size" value="8" />  <!-- Reduced cluster size -->
    
    <!-- ROI Filtering -->
    <param name="camera_fov_horizontal" value="90.0" />
    <param name="camera_fov_vertical" value="60.0" />
    <param name="max_distance" value="15.0" />  <!-- Reduced max distance -->
  </node>

  <!-- Enhanced Calibration Node (Jetson Nano Optimized) -->
  <node name="enhanced_calibration_node" pkg="camera_lidar_fusion" type="enhanced_calibration_node.py" output="screen">
    <!-- Calibration parameters (Conservative for Nano) -->
    <param name="checkerboard_size" value="[7, 5]" />  <!-- Smaller board -->
    <param name="square_size" value="0.06" />
    <param name="min_targets" value="8" />  <!-- Reduced minimum targets -->
    <param name="max_targets" value="25" />  <!-- Reduced maximum targets -->
    <param name="calibration_timeout" value="180" />  <!-- Reduced timeout -->
    
    <!-- Target detection parameters -->
    <param name="min_corner_quality" value="0.05" />  <!-- Reduced quality threshold -->
    <param name="max_corner_distance" value="0.15" />
    <param name="target_stability_threshold" value="0.03" />
    
    <!-- Circle grid parameters -->
    <param name="circle_grid_size" value="[3, 9]" />  <!-- Smaller grid -->
  </node>

  <!-- Object Detection and Tracking Node (Jetson Nano Optimized) -->
  <node name="object_detection_tracking_node" pkg="camera_lidar_fusion" type="object_detection_tracking_node.py" output="screen">
    <!-- Object detection parameters (Conservative) -->
    <param name="confidence_threshold" value="0.6" />  <!-- Increased threshold -->
    <param name="nms_threshold" value="0.5" />
    <param name="min_object_size" value="80" />  <!-- Increased minimum size -->
    <param name="max_object_size" value="800" />  <!-- Reduced maximum size -->
    
    <!-- Object tracking parameters -->
    <param name="tracking_max_distance" value="2.5" />
    <param name="tracking_max_age" value="20" />  <!-- Reduced max age -->
    <param name="tracking_min_hits" value="2" />  <!-- Reduced min hits -->
    
    <!-- 3D projection parameters -->
    <param name="projection_cone_angle" value="20.0" />  <!-- Increased angle -->
    <param name="min_projection_points" value="8" />  <!-- Reduced points -->
    <param name="max_projection_distance" value="15.0" />  <!-- Reduced distance -->
    
    <!-- Target classes (Reduced for performance) -->
    <param name="target_classes" value="['person', 'car']" />
  </node>

  <!-- Performance Monitor Node (Jetson Nano Optimized) -->
  <node name="performance_monitor_node" pkg="camera_lidar_fusion" type="performance_monitor_node.py" output="screen">
    <!-- Performance thresholds (Conservative for Nano) -->
    <param name="target_fps" value="3.0" />  <!-- Reduced target FPS -->
    <param name="max_processing_time" value="0.3" />  <!-- Increased max time -->
    <param name="max_memory_usage" value="75.0" />  <!-- Reduced memory threshold -->
    <param name="max_cpu_usage" value="85.0" />  <!-- Reduced CPU threshold -->
  </node>

  <!-- TF Static Transform Publisher for LiDAR -->
  <node name="lidar_tf_publisher" pkg="tf2_ros" type="static_transform_publisher" 
        args="0 0 0 0 0 0 base_link unilidar_lidar" />

  <!-- Distance Monitor Node (Original) -->
  <node name="distance_monitor_node" pkg="camera_lidar_fusion" type="distance_monitor_node.py" output="screen">
    <param name="warning_distance" value="0.9" />
    <param name="danger_distance" value="0.5" />
  </node>

  <!-- RViz for Visualization (Reduced complexity for Nano) -->
  <node name="rviz" pkg="rviz" type="rviz" args="-d $(find camera_lidar_fusion)/config/enhanced_fusion_jetson.rviz" output="screen" />

  <!-- Image View for Camera (Reduced resolution) -->
  <node name="left_image_view" pkg="image_view" type="image_view" output="screen">
    <remap from="image" to="/zed/left/image_raw" />
    <param name="window_name" value="ZED Left Camera" />
    <param name="image_transport" value="compressed" />  <!-- Use compressed for performance -->
  </node>

  <!-- Performance Monitor Image View -->
  <node name="performance_image_view" pkg="image_view" type="image_view" output="screen">
    <remap from="image" to="/monitor/performance_image" />
    <param name="window_name" value="Performance Monitor" />
  </node>

  <!-- Detection Image View -->
  <node name="detection_image_view" pkg="image_view" type="image_view" output="screen">
    <remap from="image" to="/detection/debug_image" />
    <param name="window_name" value="Object Detection" />
  </node>

  <!-- Calibration Image View -->
  <node name="calibration_image_view" pkg="image_view" type="image_view" output="screen">
    <remap from="image" to="/calibration/debug_image" />
    <param name="window_name" value="Calibration" />
  </node>

  <!-- Web Monitor (Optional - can be disabled for performance) -->
  <node name="web_monitor" pkg="camera_lidar_fusion" type="web_monitor.py" output="screen" />

</launch>
